#!/bin/bash

# Stop script if errors occur
trap 'echo Error: $0:$LINENO stopped; exit 1' ERR INT
set -eu

. "$DOTFILES_ROOT/script/functions"

: "Hombrew install" && {

  export HOMEBREW_NO_ANALYTICS=1

  if is_exists "brew"; then
    log_pass "Homebrew: already installed"
  else
    if ! is_exists "ruby"; then
        log_fail "error: require: ruby"
        exit 1
    fi

    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    if is_exists "brew"; then
        brew doctor
    else
        log_fail "error: brew: failed to install"
        exit 1
    fi

    log_pass "brew: installed successfully"
  fi
}


: "Hombrew setup" && {

  brew update  # https://github.com/travis-ci/travis-ci/issues/8552#issuecomment-335430374

  brew install rename
  brew install tree
  brew install wget
  brew install zsh
  brew install zsh-completions
  brew install the_silver_searcher
  brew install reattach-to-user-namespace

  brew install git
  brew install git-now
  brew install tig --with-docs
  brew install tmux
  brew install vim --with-lua --with-luajit
  brew install rlwrap

  brwe tap caskroom/cask
  brew cask google-japanese-ime
  brew cask mjolnir
  brew cask flux
  brew cask iterm2
  brew cask macdown
  brew cask appcleaner
  brew cask vagrant
  brew cask virtualbox
  brew cask google-chrome
  brew cask firefox
  brew cask dropbox
  brew cask google-drive
  brew cask font-myrica
  brew cask font-myricam

}


: "Install mjolnir dependencies" && {

  if ! is_exists "luarocks"; then
      log_fail "error: require: luarocks"
      exit 1
  fi

  luarocks list | grep mjolnir
  if [ $? -eq 1 ]; then
    luarocks install mjolnir.hotkey
    luarocks install mjolnir.application
    luarocks install mjolnir.th.hints
    luarocks install mjolnir.fnutils
    luarocks install mjolnir.geometry
    luarocks install mjolnir.screen
    luarocks install mjolnir.keycodes
  fi
}


VIM_DIR=$DOTFILES_ROOT/.vim

mkdir -p $VIM_DIR/autoload


: "Install vim-plug" && {
  if ! [ -f "$VIM_DIR/autoload/plug.vim" ] ; then
    curl -fLo $VIM_DIR/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    log_pass "vim: Install vim-plug"
  fi
}
